#!/bin/bash

FILES_DIR=$(dirname $(realpath $0))
LIVECD_DIR=${FILES_DIR}/livecd

# isolinux binary
mkdir ${LIVECD_DIR}/isolinux
cp /usr/share/syslinux/isolinux.bin ${LIVECD_DIR}/isolinux/

# isolinux support files
for i in libcom32.c32 libutil.c32 ldlinux.c32 reboot.c32 vesamenu.c32; do
    cp "/usr/share/syslinux/${i}" ${LIVECD_DIR}/isolinux/
done

# isolinux hardware detection toolkit, useful for system info and debugging
cp /usr/share/syslinux/hdt.c32 ${LIVECD_DIR}/isolinux/
cp /usr/share/hwdata/pci.ids ${LIVECD_DIR}/isolinux/

# memtest goes under isolinux since it doesn't work for uefi right now
if [ -f /usr/share/memtest86+/memtest ]; then
    cp /usr/share/memtest86+/memtest.bin ${LIVECD_DIR}/isolinux/memtest86
fi

# config files
cp ${FILES_DIR}/isolinux/* ${LIVECD_DIR}/isolinux/

# make iso
mkisofs -J -R -l -V "%VOL_ID%" -o "%FILEPATH%" \
        -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table \
        "${LIVECD_DIR}"/ || exit 1
isohybrid "%FILEPATH%"
