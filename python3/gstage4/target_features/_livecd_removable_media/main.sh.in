#!/bin/bash

FILES_DIR=$(dirname $(realpath $0))

parted --script %DEV_PATH% \
    mklabel msdos \
    mkpart primary fat32 0% 100%
mkfs.vfat -F 32 -n %LABEL% %DEV_PATH%

UUID=`blkid %DEV_PATH% -s UUID -o value`
BASE_DIR=/mnt
BOOT_DIR=${BASE_DIR}/boot
DATA_DIR=${BASE_DIR}/data/%ARCH%

mount %DEV_PATH%1 ${BASE_DIR}
mkdir -p ${BOOT_DIR} ${DATA_DIR}

mv ${FILES_DIR}/rootfs/boot/vmlinuz ${BOOT_DIR}
mv ${FILES_DIR}/rootfs/boot/initramfs.img ${BOOT_DIR}
mksquashfs ${FILESDIR}/rootfs ${DATA_DIR}/rootfs.sqfs -no-progress -noappend -quiet
sha512sum ${DATA_DIR}/rootfs.sqfs > ${DATA_DIR}/rootfs.sqfs.sha512
sed -i "s#${DATA_DIR}/\?##" ${DATA_DIR}/rootfs.sqfs.sha512                       # remove directory prefix in rootfs.sqfs.sha512, sha512sum sucks

grub-install --removable --target=x86_64-efi --boot-directory=${BOOT_DIR} --efi-directory=${BASE_DIR} --no-nvram
grub-install --removable --target=i386-pc --boot-directory=${BOOT_DIR}
sed "s/%UUID%/${UUID}/g" ${FILES_DIR}/grub.cfg.in > ${BOOT_DIR}/grub/grub.cfg
