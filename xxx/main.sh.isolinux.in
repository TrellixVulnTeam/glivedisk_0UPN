#!/bin/bash

FILES_DIR=$(dirname $(realpath $0))
SRC_DIR=${FILES_DIR}/rootfs
LIVECD_DIR${FILES_DIR}/livecd

# isolinux binary
mkdir ${SRC_DIR}/isolinux
cp /usr/share/syslinux/isolinux.bin ${SRC_DIR}/isolinux/

# isolinux support files
for i in libcom32.c32 libutil.c32 ldlinux.c32 reboot.c32 vesamenu.c32; do
    cp "/usr/share/syslinux/${i}" ${SRC_DIR}/isolinux/
done

# isolinux hardware detection toolkit, useful for system info and debugging
cp /usr/share/syslinux/hdt.c32 ${SRC_DIR}/isolinux/
cp /usr/share/hwdata/pci.ids ${SRC_DIR}/isolinux/

# memtest goes under isolinux since it doesn't work for uefi right now
if [ -f /usr/share/memtest86+/memtest ]; then
    cp /usr/share/memtest86+/memtest.bin ${SRC_DIR}/isolinux/memtest86
fi

# config files
cp ${FILES_DIR}/isolinux/* ${SRC_DIR}/isolinux/

# make iso
mv ${SRC_DIR}/boot/vmlinuz ${BOOT_DIR}
mv ${SRC_DIR}/boot/initramfs.img ${BOOT_DIR}
mksquashfs ${FILESDIR}/rootfs ${DATA_DIR}/rootfs.sqfs -no-progress -noappend -quiet
sha512sum ${DATA_DIR}/rootfs.sqfs > ${DATA_DIR}/rootfs.sqfs.sha512
sed -i "s#${DATA_DIR}/\?##" ${DATA_DIR}/rootfs.sqfs.sha512                       # remove directory prefix in rootfs.sqfs.sha512, sha512sum sucks

mkisofs -J -R -l -V "%VOL_ID%" -o "%FILEPATH%" \
        -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table \
        "${SRC_DIR}"/ || exit 1
isohybrid "%FILEPATH%"
